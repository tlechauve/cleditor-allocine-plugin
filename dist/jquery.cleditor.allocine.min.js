/*! allocine plugin for cleditor - v0.1.0 - 2012-08-05
* https://github.com/tlechauve/cleditor-allocine-plugin
* Copyright (c) 2012 Thomas Lechauve; Licensed MIT */
var Mustache;(function(a){typeof module!="undefined"?module.exports=a:typeof define=="function"?define(a):Mustache=a})(function(){function h(a,b){return RegExp.prototype.test.call(a,b)}function i(a){return!h(d,a)}function l(a){var b=a.replace(k,function(a){return"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)});return'"'+b+'"'}function m(a){return a.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}function o(a){return String(a).replace(/[&<>"'\/]/g,function(a){return n[a]})}function p(a){this.string=a,this.tail=a,this.pos=0}function q(a,b){this.view=a,this.parent=b,this.clearCache()}function r(){this.clearCache()}function s(a,b){var c=['""'],d,e,f;for(var g=0,h=a.length;g<h;++g){d=a[g];switch(d.type){case"#":case"^":e=d.type==="#"?"_section":"_inverted",c.push("r."+e+"("+l(d.value)+", c, function (c, r) {\n"+"  "+s(d.tokens,!0)+"\n"+"})");break;case"{":case"&":case"name":f=d.type==="name"?"true":"false",c.push("r._name("+l(d.value)+", c, "+f+")");break;case">":c.push("r._partial("+l(d.value)+", c)");break;case"text":c.push(l(d.value))}}return c="return "+c.join(" + ")+";",b?c:new Function("c, r",c)}function t(a){if(a.length===2)return[new RegExp(m(a[0])+"\\s*"),new RegExp("\\s*"+m(a[1]))];throw new Error("Invalid tags: "+a.join(" "))}function u(a){var b=[],c=b,d=[],e,f;for(var g=0;g<a.length;++g){e=a[g];switch(e.type){case"#":case"^":e.tokens=[],d.push(e),c.push(e),c=e.tokens;break;case"/":if(d.length===0)throw new Error("Unopened section: "+e.value);f=d.pop();if(f.value!==e.value)throw new Error("Unclosed section: "+f.value);d.length>0?c=d[d.length-1].tokens:c=b;break;default:c.push(e)}}f=d.pop();if(f)throw new Error("Unclosed section: "+f.value);return b}function v(a){var b;for(var c=0;c<a.length;++c){var d=a[c];b&&b.type==="text"&&d.type==="text"?(b.value+=d.value,a.splice(c--,1)):b=d}}function w(d,h){h=h||a.tags;var j=t(h),k=new p(d),l=[],n=[],o=!1,q=!1,r=function(){if(o&&!q)while(n.length)l.splice(n.pop(),1);else n=[];o=!1,q=!1},s,w,x;while(!k.eos()){w=k.scanUntil(j[0]);if(w)for(var y=0,z=w.length;y<z;++y)x=w.charAt(y),i(x)?n.push(l.length):q=!0,l.push({type:"text",value:x}),x==="\n"&&r();if(!k.scan(j[0]))break;o=!0,s=k.scan(g)||"name",k.scan(b);if(s==="=")w=k.scanUntil(e),k.scan(e),k.scanUntil(j[1]);else if(s==="{"){var A=new RegExp("\\s*"+m("}"+h[1]));w=k.scanUntil(A),k.scan(f),k.scanUntil(j[1])}else w=k.scanUntil(j[1]);if(!k.scan(j[1]))throw new Error("Unclosed tag at "+k.pos);l.push({type:s,value:w});if(s==="name"||s==="{"||s==="&")q=!0;s==="="&&(h=w.split(c),j=t(h))}return v(l),u(l)}function y(){x.clearCache()}function z(a,b){return x.compile(a,b)}function A(a,b,c){return x.compilePartial(a,b,c)}function B(a,b,c){if(c)for(var d in c)A(d,c[d]);return x.render(a,b)}var a={};a.name="mustache.js",a.version="0.5.2",a.tags=["{{","}}"],a.parse=w,a.clearCache=y,a.compile=z,a.compilePartial=A,a.render=B,a.Scanner=p,a.Context=q,a.Renderer=r,a.to_html=function(a,b,c,d){var e=B(a,b,c);if(typeof d=="function")d(e);else return e};var b=/\s*/,c=/\s+/,d=/\S/,e=/\s*=/,f=/\s*\}/,g=/#|\^|\/|>|\{|&|=|!/,j=Array.isArray||function(a){return Object.prototype.toString.call(a)==="[object Array]"},k=/[\x00-\x2F\x3A-\x40\x5B-\x60\x7B-\xFF\u2028\u2029]/gm,n={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"};a.isWhitespace=i,a.isArray=j,a.quote=l,a.escapeRe=m,a.escapeHtml=o,p.prototype.eos=function(){return this.tail===""},p.prototype.scan=function(a){var b=this.tail.match(a);return b&&b.index===0?(this.tail=this.tail.substring(b[0].length),this.pos+=b[0].length,b[0]):""},p.prototype.scanUntil=function(a){var b,c=this.tail.search(a);switch(c){case-1:b=this.tail,this.pos+=this.tail.length,this.tail="";break;case 0:b="";break;default:b=this.tail.substring(0,c),this.tail=this.tail.substring(c),this.pos+=c}return b},q.make=function(a){return a instanceof q?a:new q(a)},q.prototype.clearCache=function(){this._cache={}},q.prototype.push=function(a){return new q(a,this)},q.prototype.lookup=function(a){var b=this._cache[a];if(!b){if(a===".")b=this.view;else{var c=this;while(c){if(a.indexOf(".")>0){var d=a.split("."),e=0;b=c.view;while(b&&e<d.length)b=b[d[e++]]}else b=c.view[a];if(b!=null)break;c=c.parent}}this._cache[a]=b}return typeof b=="function"&&(b=b.call(this.view)),b},r.prototype.clearCache=function(){this._cache={},this._partialCache={}},r.prototype.compile=function(a,b){typeof a=="string"&&(a=w(a,b));var c=s(a),d=this;return function(a){return c(q.make(a),d)}},r.prototype.compilePartial=function(a,b,c){return this._partialCache[a]=this.compile(b,c),this._partialCache[a]},r.prototype.render=function(a,b){var c=this._cache[a];return c||(c=this.compile(a),this._cache[a]=c),c(b)},r.prototype._section=function(a,b,c){var d=b.lookup(a);switch(typeof d){case"object":if(j(d)){var e="";for(var f=0,g=d.length;f<g;++f)e+=c(b.push(d[f]),this);return e}return d?c(b.push(d),this):"";case"function":var h=c(b,this),i=this,k=function(a){return i.render(a,b)};return d.call(b.view,h,k)||"";default:if(d)return c(b,this)}return""},r.prototype._inverted=function(a,b,c){var d=b.lookup(a);return d==null||d===!1||j(d)&&d.length===0?c(b,this):""},r.prototype._partial=function(a,b){var c=this._partialCache[a];return c?c(b):""},r.prototype._name=function(a,b,c){var d=b.lookup(a);typeof d=="function"&&(d=d.call(b.view));var e=d==null?"":String(d);return c?o(e):e};var x=new r;return a}()),function(a){var b=function(b,d){a(d.popup).children("input#searchmovie").keyup(function(){var b=a(this);b.data("timeout")&&clearTimeout(b.data("timeout")),b.data("timeout",setTimeout(function(){var e=b.val().trim().toLowerCase();e.length>1?a("#movielist").html("").allocine("searchMovie",e,{success:function(b){var e=a(this);b.feed.count>1&&(e.html(Mustache.render(a.tplallocine.movieitem,b.feed)),e.find("li").click(function(){c(a(this).data("idcode"),d)}))}}):a("#movielist").html("")},500))})},c=function(b,c){var d=c.editor;a(d).allocine("getMovie",b,{success:function(b){var e=a.tplallocine.movie.substr(0,a.tplallocine.movie.indexOf("</style>")+8),f=a.tplallocine.movie.replace(e,""),g=b.movie.release.releaseDate.split("-"),h=["janvier","février","mars","avril","mai","juin","juillet","août","septembre","octobre","novembre","décembre"],i=[g[2],h[parseInt(g[1],10)-1],g[0]].join(" ");b.movie.release.releaseDate=i,b.movie.runtime=""+Math.floor(b.movie.runtime/3600)+"h"+b.movie.runtime%3600/60,a(d.doc.head).html(e),d.execCommand(c.command,Mustache.render(f,b.movie),null,c.button)}}),d.hidePopups(),d.focus()};a.cleditor.buttons.movie={name:"movie",image:"allocine.png",title:"Créer une fiche de film",command:"inserthtml",popupName:"movie",popupClass:"cleditorPrompt",popupContent:a.tplallocine.popup,buttonClick:b},a.cleditor.defaultOptions.controls=a.cleditor.defaultOptions.controls.replace("bold","movie bold")}(jQuery);